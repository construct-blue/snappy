#!/usr/bin/env php
<?php
declare(strict_types=1);

chdir(dirname(__DIR__));

exec('composer install --no-dev --optimize-autoloader');
exec('yarn install');
exec('yarn build');
exec('rm -rf dist');
exec('mkdir dist');
exec('mkdir dist/data');

const FOLDERS = [
        'public',
        'src',
        'vendor',
];

foreach (FOLDERS as $FOLDER) {
    exec("cp -r $FOLDER dist/$FOLDER");
}

exec("cp LICENSE dist/");
exec("cp env.php.dist dist/");
exec("echo 'rc' >> dist/VERSION");

// CWD /dist/
chdir('dist');
$autoloader = require 'vendor/autoload.php';

(new \Blue\Core\View\EntrypointHelper(getcwd() . '/'))->build();

global $env;
$env = [];

/** @var Blue\Core\Application\Server\SnappyServer $application */
$application = require 'src/bootstrap.php';
$application->build();
chdir(dirname(__DIR__));
// CWD /

// restore dev env
exec('composer install');
exec('yarn dev');